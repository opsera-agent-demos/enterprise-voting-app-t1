# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPLOYMENT LANDSCAPE - opseravote1
# Generates deployment dashboard and publishes to S3 hub
# Generated by Opsera Code-to-Cloud Enterprise v0.920
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "Landscape (opseravote1)"

on:
  workflow_dispatch:
  workflow_call:

env:
  APP_NAME: opseravote1
  AWS_REGION: us-west-2
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  generate-landscape:
    name: "ðŸŒ Generate Landscape"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Collect Deployment Data
        id: collect
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}

          # Collect pod status for each environment
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          for ENV in dev; do
            NS="${{ env.APP_NAME }}-${ENV}"
            VOTE_STATUS=$(kubectl get deploy vote -n $NS -o jsonpath='{.status.readyReplicas}/{.spec.replicas}' 2>/dev/null || echo "0/0")
            RESULT_STATUS=$(kubectl get deploy result -n $NS -o jsonpath='{.status.readyReplicas}/{.spec.replicas}' 2>/dev/null || echo "0/0")
            WORKER_STATUS=$(kubectl get deploy worker -n $NS -o jsonpath='{.status.readyReplicas}/{.spec.replicas}' 2>/dev/null || echo "0/0")
            IMAGE_TAG=$(kubectl get deploy vote -n $NS -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null | awk -F: '{print $NF}' || echo "unknown")

            echo "${ENV}_vote_status=${VOTE_STATUS}" >> $GITHUB_OUTPUT
            echo "${ENV}_result_status=${RESULT_STATUS}" >> $GITHUB_OUTPUT
            echo "${ENV}_worker_status=${WORKER_STATUS}" >> $GITHUB_OUTPUT
            echo "${ENV}_image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          done

          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Generate Landscape JSON
        run: |
          cat > /tmp/opseravote1-landscape.json << 'LANDSCAPE_EOF'
          {
            "app": "opseravote1",
            "tenant": "opsera",
            "region": "us-west-2",
            "cluster": "opsera-usw2-np",
            "timestamp": "${{ steps.collect.outputs.timestamp }}",
            "repository": "${{ github.repository }}",
            "environments": {
              "dev": {
                "namespace": "opseravote1-dev",
                "strategy": "rolling",
                "services": {
                  "vote": {"status": "${{ steps.collect.outputs.dev_vote_status }}", "url": "https://vote-opseravote1-dev.agent.opsera.dev"},
                  "result": {"status": "${{ steps.collect.outputs.dev_result_status }}", "url": "https://result-opseravote1-dev.agent.opsera.dev"},
                  "worker": {"status": "${{ steps.collect.outputs.dev_worker_status }}"}
                },
                "image_tag": "${{ steps.collect.outputs.dev_image_tag }}"
              }
            },
            "pipeline": {
              "security": "Gitleaks + Grype",
              "quality": "SonarQube",
              "notifications": "Slack + Jira",
              "monitoring": "New Relic APM"
            }
          }
          LANDSCAPE_EOF

      - name: Publish to S3
        continue-on-error: true
        run: |
          aws s3 cp /tmp/opseravote1-landscape.json \
            s3://opsera-deployment-landscapes/apps/opseravote1/landscape.json \
            --content-type "application/json" 2>/dev/null || \
          echo "âš ï¸ S3 bucket not configured - landscape saved locally" >> $GITHUB_STEP_SUMMARY

      - name: Generate Summary
        run: |
          echo "# ðŸŒ Deployment Landscape: opseravote1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Updated:** ${{ steps.collect.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## DEV Environment" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Vote | ${{ steps.collect.outputs.dev_vote_status }} | [vote-opseravote1-dev.agent.opsera.dev](https://vote-opseravote1-dev.agent.opsera.dev) |" >> $GITHUB_STEP_SUMMARY
          echo "| Result | ${{ steps.collect.outputs.dev_result_status }} | [result-opseravote1-dev.agent.opsera.dev](https://result-opseravote1-dev.agent.opsera.dev) |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | ${{ steps.collect.outputs.dev_worker_status }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** \`${{ steps.collect.outputs.dev_image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** [deployments.agent.opsera.dev](https://deployments.agent.opsera.dev)" >> $GITHUB_STEP_SUMMARY
