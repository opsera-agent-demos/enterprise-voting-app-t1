# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DIAGNOSTICS - opseravote1
# Full pipeline debugging and health check
# Generated by Opsera Code-to-Cloud Enterprise v0.920
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "Diagnostics (opseravote1)"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to diagnose'
        type: choice
        options: ['dev']
        default: 'dev'
      runner:
        description: 'Runner type'
        type: choice
        options: ['github-hosted', 'self-hosted']
        default: 'github-hosted'

env:
  APP_NAME: opseravote1
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

jobs:
  diagnose:
    name: "ðŸ” Diagnostics"
    runs-on: ${{ inputs.runner == 'self-hosted' && fromJSON('["self-hosted", "linux", "opsera"]') || 'ubuntu-latest' }}
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check ECR
        run: |
          echo "### ðŸ“¦ ECR Repositories" >> $GITHUB_STEP_SUMMARY
          for SERVICE in vote result worker; do
            REPO="opsera/${{ env.APP_NAME }}-${SERVICE}"
            IMAGES=$(aws ecr list-images --repository-name $REPO --query 'imageIds[*].imageTag' --output text 2>/dev/null | head -5 || echo "NOT FOUND")
            echo "- **${SERVICE}**: ${IMAGES}" >> $GITHUB_STEP_SUMMARY
          done

      - name: Check ArgoCD
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          echo "### ðŸ”„ ArgoCD Application" >> $GITHUB_STEP_SUMMARY
          STATUS=$(kubectl get application ${{ env.APP_NAME }}-${{ inputs.environment }} -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "NOT FOUND")
          HEALTH=$(kubectl get application ${{ env.APP_NAME }}-${{ inputs.environment }} -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "UNKNOWN")
          echo "- **Sync:** ${STATUS}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health:** ${HEALTH}" >> $GITHUB_STEP_SUMMARY

      - name: Check Pods
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NS="${{ env.APP_NAME }}-${{ inputs.environment }}"
          echo "### ðŸ³ Pod Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n $NS -o wide 2>/dev/null || echo "No pods found in namespace $NS"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Services
        run: |
          NS="${{ env.APP_NAME }}-${{ inputs.environment }}"
          echo "### ðŸŒ Services" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n $NS 2>/dev/null || echo "No services found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check Ingress
        run: |
          NS="${{ env.APP_NAME }}-${{ inputs.environment }}"
          echo "### ðŸ”— Ingress" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get ingress -n $NS 2>/dev/null || echo "No ingress found"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Recent Events
        run: |
          NS="${{ env.APP_NAME }}-${{ inputs.environment }}"
          echo "### ðŸ“‹ Recent Events" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n $NS --sort-by=.lastTimestamp 2>/dev/null | tail -20 || echo "No events"
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Test URLs
        run: |
          echo "### ðŸŒ URL Tests" >> $GITHUB_STEP_SUMMARY
          for URL in "https://vote-opseravote1-${{ inputs.environment }}.agent.opsera.dev" "https://result-opseravote1-${{ inputs.environment }}.agent.opsera.dev"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$URL" 2>/dev/null || echo "TIMEOUT")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "- âœ… ${URL} â†’ ${HTTP_CODE}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ ${URL} â†’ ${HTTP_CODE}" >> $GITHUB_STEP_SUMMARY
            fi
          done
