# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CI BUILD & DEPLOY - voting01 QA (Canary)
# MANUAL GATE: Requires manual trigger from GitHub Actions UI
# Progressive rollout: 20% โ 50% โ 100% with New Relic analysis
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

name: "๐ Promote to QA"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag from DEV (check DEV kustomization.yaml)'
        required: true
        type: string
      runner:
        description: 'Runner type'
        type: choice
        options: ['github-hosted', 'self-hosted']
        default: 'github-hosted'

env:
  APP_NAME: voting01
  ENVIRONMENT: qa
  AWS_REGION: us-west-2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np

permissions:
  contents: write
  actions: write

jobs:
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # GET IMAGE TAG
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  get-tag:
    name: "๐ท๏ธ Validate Image Tag"
    runs-on: ${{ github.event.inputs.runner == 'self-hosted' && fromJSON('["self-hosted", "linux", "opsera"]') || 'ubuntu-latest' }}
    outputs:
      image_tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate Image Tag
        id: tag
        run: |
          TAG="${{ github.event.inputs.image_tag }}"
          if [ -z "$TAG" ]; then
            echo "โ Error: Image tag is required"
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          echo "### ๐ Promoting to QA" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`$TAG\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Manual Promotion |" >> $GITHUB_STEP_SUMMARY

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # DEPLOY TO QA (CANARY)
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  deploy:
    name: "๐ Deploy QA (Canary)"
    needs: [get-tag]
    runs-on: ${{ github.event.inputs.runner == 'self-hosted' && fromJSON('["self-hosted", "linux", "opsera"]') || 'ubuntu-latest' }}
    outputs:
      success: ${{ steps.verify.outputs.success }}
      failed_service: ${{ steps.verify.outputs.failed_service }}
      failure_reason: ${{ steps.verify.outputs.failure_reason }}
      rollback_step: ${{ steps.verify.outputs.rollback_step }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}

      - name: Update Kustomization
        run: |
          cd .opsera-voting01/k8s/overlays/${{ env.ENVIRONMENT }}
          sed -i "s|newTag:.*|newTag: ${{ needs.get-tag.outputs.image_tag }}|g" kustomization.yaml

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .opsera-voting01/
          git diff --cached --quiet || git commit -m "deploy(voting01-qa): ${{ needs.get-tag.outputs.image_tag }} [skip ci]"
          git pull --rebase origin main
          git push origin main

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup New Relic Secret
        env:
          NEW_RELIC_LICENSE_KEY: ${{ secrets.NEW_RELIC_LICENSE_KEY }}
        run: |
          if [ -z "$NEW_RELIC_LICENSE_KEY" ]; then
            echo "โ๏ธ NEW_RELIC_LICENSE_KEY not configured - skipping New Relic setup" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          # Create namespace if it doesn't exist
          kubectl get namespace $NS || kubectl create namespace $NS

          # Create or update the New Relic license secret
          kubectl create secret generic newrelic-license \
            --from-literal=NEW_RELIC_LICENSE_KEY="$NEW_RELIC_LICENSE_KEY" \
            --namespace=$NS \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "โ New Relic secret configured for $NS" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup Stale AnalysisRuns
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          echo "๐งน Cleaning up stale AnalysisRuns in $NS..."

          # Get current pod template hashes from active rollouts
          VOTE_HASH=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.currentPodHash}' 2>/dev/null || echo "")
          RESULT_HASH=$(kubectl get rollout result -n $NS -o jsonpath='{.status.currentPodHash}' 2>/dev/null || echo "")

          # Count before cleanup
          TOTAL_BEFORE=$(kubectl get analysisrun -n $NS --no-headers 2>/dev/null | wc -l | tr -d ' ')
          echo "  Total AnalysisRuns before cleanup: ${TOTAL_BEFORE}"

          # Delete completed/failed AnalysisRuns that DON'T belong to current revision
          DELETED=0
          for AR in $(kubectl get analysisrun -n $NS -o jsonpath='{range .items[*]}{.metadata.name}{" "}{end}' 2>/dev/null); do
            AR_HASH=$(kubectl get analysisrun "$AR" -n $NS -o jsonpath='{.metadata.labels.rollouts-pod-template-hash}' 2>/dev/null || echo "")
            AR_PHASE=$(kubectl get analysisrun "$AR" -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "")

            # Skip if it belongs to the current revision of either rollout
            if [ "$AR_HASH" = "$VOTE_HASH" ] || [ "$AR_HASH" = "$RESULT_HASH" ]; then
              continue
            fi

            # Delete if it's completed (Successful or Failed) and from an old revision
            if [ "$AR_PHASE" = "Successful" ] || [ "$AR_PHASE" = "Failed" ]; then
              kubectl delete analysisrun "$AR" -n $NS 2>/dev/null && DELETED=$((DELETED + 1))
            fi
          done

          TOTAL_AFTER=$(kubectl get analysisrun -n $NS --no-headers 2>/dev/null | wc -l | tr -d ' ')
          echo "  Deleted: ${DELETED} stale AnalysisRuns"
          echo "  Remaining: ${TOTAL_AFTER}"

          echo "### ๐งน AnalysisRun Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Before | ${TOTAL_BEFORE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deleted (stale) | ${DELETED} |" >> $GITHUB_STEP_SUMMARY
          echo "| Remaining | ${TOTAL_AFTER} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Trigger ArgoCD Sync
        run: |
          aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
          kubectl annotate application ${{ env.APP_NAME }}-${{ env.ENVIRONMENT }} -n argocd argocd.argoproj.io/refresh=hard --overwrite

      - name: Query New Relic Baseline Metrics
        id: nr_baseline
        continue-on-error: true
        run: |
          echo "### ๐ New Relic APM Baseline Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Query mock New Relic server for baseline metrics
          NR_HOST="opsera-opsera-newrelic-dev.agent.opsera.dev"

          echo "Querying baseline metrics from New Relic mock server..."

          # Get vote service metrics
          VOTE_METRICS=$(curl -s --max-time 10 \
            "https://${NR_HOST}/v1/metrics?app=voting01-vote-qa&metric=errorRate&window=5m" \
            2>/dev/null || echo '{"errorRate": 0}')
          VOTE_ERROR=$(echo "$VOTE_METRICS" | grep -oE '"errorRate"[[:space:]]*:[[:space:]]*[0-9.]+' | grep -oE '[0-9.]+$' || echo "0")

          # Get result service metrics
          RESULT_METRICS=$(curl -s --max-time 10 \
            "https://${NR_HOST}/v1/metrics?app=voting01-result-qa&metric=errorRate&window=5m" \
            2>/dev/null || echo '{"errorRate": 0}')
          RESULT_ERROR=$(echo "$RESULT_METRICS" | grep -oE '"errorRate"[[:space:]]*:[[:space:]]*[0-9.]+' | grep -oE '[0-9.]+$' || echo "0")

          echo "| Service | Error Rate | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------------|-----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Check vote error rate
          if [ "$(echo "$VOTE_ERROR < 2" | bc -l 2>/dev/null || echo 1)" = "1" ]; then
            echo "| Vote | ${VOTE_ERROR:-0}% | 2% | โ OK |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Vote | ${VOTE_ERROR:-0}% | 2% | โ๏ธ High |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check result error rate
          if [ "$(echo "$RESULT_ERROR < 2" | bc -l 2>/dev/null || echo 1)" = "1" ]; then
            echo "| Result | ${RESULT_ERROR:-0}% | 2% | โ OK |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Result | ${RESULT_ERROR:-0}% | 2% | โ๏ธ High |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Metrics from New Relic Mock Server: ${NR_HOST}_" >> $GITHUB_STEP_SUMMARY

      - name: Live Canary Dashboard
        id: verify
        run: |
          aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
          NS="${{ env.APP_NAME }}-${{ env.ENVIRONMENT }}"

          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ                    ๐ QA CANARY DEPLOYMENT LIVE DASHBOARD                    โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฃ"
          echo "โ App: voting01                    Environment: QA                             โ"
          echo "โ Strategy: Canary (20% โ 50% โ 100%)                                          โ"
          echo "โ Analysis: HTTP Health + New Relic Error Rate (< 2%)                          โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""

          # Initialize step summary
          echo "### ๐ฏ QA Canary Deployment Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Traffic | Analysis |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|----------|" >> $GITHUB_STEP_SUMMARY

          MAX_ITERATIONS=80
          POLL_INTERVAL=15

          for i in $(seq 1 $MAX_ITERATIONS); do
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Poll $i/$MAX_ITERATIONS - $(date '+%H:%M:%S')"
            echo ""

            # Get detailed rollout status for vote
            VOTE_PHASE=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            VOTE_WEIGHT=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.canary.weights.canary}' 2>/dev/null || echo "0")
            VOTE_STABLE=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.canary.weights.stable}' 2>/dev/null || echo "100")
            VOTE_STEP=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.currentStepIndex}' 2>/dev/null || echo "0")
            VOTE_MSG=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.message}' 2>/dev/null || echo "")

            # Get detailed rollout status for result
            RESULT_PHASE=$(kubectl get rollout result -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
            RESULT_WEIGHT=$(kubectl get rollout result -n $NS -o jsonpath='{.status.canary.weights.canary}' 2>/dev/null || echo "0")
            RESULT_STABLE=$(kubectl get rollout result -n $NS -o jsonpath='{.status.canary.weights.stable}' 2>/dev/null || echo "100")
            RESULT_STEP=$(kubectl get rollout result -n $NS -o jsonpath='{.status.currentStepIndex}' 2>/dev/null || echo "0")

            # Get worker status (simpler canary)
            WORKER_PHASE=$(kubectl get rollout worker -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")

            # Display vote rollout
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ ๐ณ๏ธ  VOTE SERVICE                                                            โ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค"
            printf "โ Phase: %-12s  Step: %-3s  Canary: %3s%%  Stable: %3s%%              โ\n" "$VOTE_PHASE" "$VOTE_STEP" "${VOTE_WEIGHT:-0}" "${VOTE_STABLE:-100}"
            [ -n "$VOTE_MSG" ] && echo "โ Message: $VOTE_MSG"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            # Display result rollout
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ ๐ RESULT SERVICE                                                           โ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค"
            printf "โ Phase: %-12s  Step: %-3s  Canary: %3s%%  Stable: %3s%%              โ\n" "$RESULT_PHASE" "$RESULT_STEP" "${RESULT_WEIGHT:-0}" "${RESULT_STABLE:-100}"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            # Display worker rollout
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ โ๏ธ  WORKER SERVICE                                                          โ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค"
            printf "โ Phase: %-12s                                                        โ\n" "$WORKER_PHASE"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            # Get current revision pod template hashes to filter analysis runs
            VOTE_HASH=$(kubectl get rollout vote -n $NS -o jsonpath='{.status.currentPodHash}' 2>/dev/null || echo "")
            RESULT_HASH=$(kubectl get rollout result -n $NS -o jsonpath='{.status.currentPodHash}' 2>/dev/null || echo "")

            # Show analysis runs for current revision only
            echo ""
            echo "๐ Active Analysis Runs (current revision):"
            if [ -n "$VOTE_HASH" ]; then
              kubectl get analysisrun -n $NS -l rollouts-pod-template-hash=$VOTE_HASH --sort-by=.metadata.creationTimestamp 2>/dev/null | tail -5 || true
            fi
            if [ -n "$RESULT_HASH" ] && [ "$RESULT_HASH" != "$VOTE_HASH" ]; then
              kubectl get analysisrun -n $NS -l rollouts-pod-template-hash=$RESULT_HASH --sort-by=.metadata.creationTimestamp 2>/dev/null | tail -5 || true
            fi

            # Get latest analysis run for current revision (not stale ones)
            LATEST_AR=""
            if [ -n "$VOTE_HASH" ]; then
              LATEST_AR=$(kubectl get analysisrun -n $NS -l rollouts-pod-template-hash=$VOTE_HASH --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}' 2>/dev/null || echo "")
            fi
            if [ -z "$LATEST_AR" ] && [ -n "$RESULT_HASH" ]; then
              LATEST_AR=$(kubectl get analysisrun -n $NS -l rollouts-pod-template-hash=$RESULT_HASH --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1].metadata.name}' 2>/dev/null || echo "")
            fi

            if [ -n "$LATEST_AR" ]; then
              AR_PHASE=$(kubectl get analysisrun $LATEST_AR -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
              AR_MSG=$(kubectl get analysisrun $LATEST_AR -n $NS -o jsonpath='{.status.message}' 2>/dev/null || echo "")
              echo ""
              echo "๐ฌ Latest Analysis (current revision): $LATEST_AR"
              echo "   Status: $AR_PHASE"
              [ -n "$AR_MSG" ] && echo "   Message: $AR_MSG"
            fi

            # Check for success
            if [ "$VOTE_PHASE" = "Healthy" ] && [ "$RESULT_PHASE" = "Healthy" ] && [ "$WORKER_PHASE" = "Healthy" ]; then
              echo ""
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              echo "โ                    โ CANARY DEPLOYMENT SUCCESSFUL!                          โ"
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

              # Update summary with final status
              echo "| Vote | โ Healthy | 100% | Passed |" >> $GITHUB_STEP_SUMMARY
              echo "| Result | โ Healthy | 100% | Passed |" >> $GITHUB_STEP_SUMMARY
              echo "| Worker | โ Healthy | 100% | N/A |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ๐ Application URLs" >> $GITHUB_STEP_SUMMARY
              echo "- **Vote App**: https://vote-voting01-qa.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
              echo "- **Result App**: https://result-voting01-qa.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY
              echo "- **Argo Rollouts Dashboard**: https://rollouts-voting01-qa.agent.opsera.dev" >> $GITHUB_STEP_SUMMARY

              echo "success=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            # Check for degraded/failed
            if [ "$VOTE_PHASE" = "Degraded" ] || [ "$RESULT_PHASE" = "Degraded" ] || [ "$WORKER_PHASE" = "Degraded" ]; then
              echo ""
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              echo "โ                    โ CANARY DEPLOYMENT FAILED - ROLLING BACK               โ"
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

              # Identify which service(s) failed
              FAILED_SVCS=""
              [ "$VOTE_PHASE" = "Degraded" ] && FAILED_SVCS="vote"
              [ "$RESULT_PHASE" = "Degraded" ] && FAILED_SVCS="${FAILED_SVCS:+$FAILED_SVCS, }result"
              [ "$WORKER_PHASE" = "Degraded" ] && FAILED_SVCS="${FAILED_SVCS:+$FAILED_SVCS, }worker"

              # Determine which canary phase the failure occurred at
              FAILED_STEP="unknown"
              for svc in vote result worker; do
                svc_phase=$(kubectl get rollout $svc -n $NS -o jsonpath='{.status.phase}' 2>/dev/null || echo "")
                if [ "$svc_phase" = "Degraded" ]; then
                  step_idx=$(kubectl get rollout $svc -n $NS -o jsonpath='{.status.currentStepIndex}' 2>/dev/null || echo "0")
                  case "$step_idx" in
                    0|1|2) FAILED_STEP="Phase 1 (20% traffic)" ;;
                    3|4|5) FAILED_STEP="Phase 2 (50% traffic)" ;;
                    6|7|8) FAILED_STEP="Phase 3 (100% traffic)" ;;
                    *) FAILED_STEP="Step $step_idx" ;;
                  esac
                  break
                fi
              done

              # Get failure reason from failed analysis runs
              FAIL_REASON=$(kubectl get analysisrun -n $NS -o jsonpath='{range .items[?(@.status.phase=="Failed")]}{.status.message}{"\n"}{end}' 2>/dev/null | head -1 || echo "Unknown")
              [ -z "$FAIL_REASON" ] && FAIL_REASON="Unknown"

              # Get failure reason
              echo ""
              echo "๐ Failure Analysis:"
              kubectl describe rollout vote -n $NS 2>/dev/null | grep -A5 "Message:" || true

              # Show analysis run failures
              echo ""
              echo "๐ Failed Analysis Runs:"
              kubectl get analysisrun -n $NS -o jsonpath='{range .items[?(@.status.phase=="Failed")]}{.metadata.name}{"\t"}{.status.phase}{"\t"}{.status.message}{"\n"}{end}' 2>/dev/null || true

              # Update summary
              echo "| Vote | โ $VOTE_PHASE | ${VOTE_WEIGHT:-0}% | Failed |" >> $GITHUB_STEP_SUMMARY
              echo "| Result | โ $RESULT_PHASE | ${RESULT_WEIGHT:-0}% | Failed |" >> $GITHUB_STEP_SUMMARY
              echo "| Worker | โ $WORKER_PHASE | N/A | N/A |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "โ๏ธ **Automatic rollback triggered** - canary analysis detected issues" >> $GITHUB_STEP_SUMMARY

              # Export rollback details for downstream jobs (Jira)
              echo "success=false" >> $GITHUB_OUTPUT
              echo "failed_service=${FAILED_SVCS}" >> $GITHUB_OUTPUT
              echo "failure_reason=${FAIL_REASON}" >> $GITHUB_OUTPUT
              echo "rollback_step=${FAILED_STEP}" >> $GITHUB_OUTPUT
              exit 1
            fi

            echo ""
            echo "โณ Waiting ${POLL_INTERVAL}s before next check..."
            sleep $POLL_INTERVAL
          done

          echo "โฑ๏ธ Timeout: Canary rollout did not complete within expected time" >> $GITHUB_STEP_SUMMARY
          echo "success=false" >> $GITHUB_OUTPUT
          exit 1

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # NOTIFICATIONS
  # Note: Staging promotion is MANUAL - use "Promote to Staging" workflow
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  notify-slack:
    name: "๐ข Slack"
    needs: [get-tag, deploy]
    if: always()
    runs-on: ${{ github.event.inputs.runner == 'self-hosted' && fromJSON('["self-hosted", "linux", "opsera"]') || 'ubuntu-latest' }}
    steps:
      - name: Determine Status
        id: status
        run: |
          if [ "${{ needs.deploy.outputs.success }}" = "true" ]; then
            echo "emoji=โ" >> $GITHUB_OUTPUT
            echo "title=QA Canary Succeeded" >> $GITHUB_OUTPUT
          else
            echo "emoji=โ" >> $GITHUB_OUTPUT
            echo "title=QA Canary Failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.title }} - voting01-qa",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.title }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*App:*\n`voting01`"},
                    {"type": "mrkdwn", "text": "*Environment:*\n`QA (Canary)`"},
                    {"type": "mrkdwn", "text": "*Tag:*\n`${{ needs.get-tag.outputs.image_tag }}`"},
                    {"type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [{
                    "type": "button",
                    "text": {"type": "plain_text", "text": "View Workflow"},
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
  # JIRA - Create rollback ticket on canary failure
  # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

  notify-jira:
    name: "๐ Jira Rollback Ticket"
    needs: [get-tag, deploy]
    if: always() && needs.deploy.outputs.success == 'false'
    runs-on: ${{ github.event.inputs.runner == 'self-hosted' && fromJSON('["self-hosted", "linux", "opsera"]') || 'ubuntu-latest' }}
    continue-on-error: true
    steps:
      - name: Check Jira Configuration
        id: check-jira
        run: |
          CONFIGURED="true"
          MISSING=""

          if [ -z "${{ secrets.JIRA_API_TOKEN }}" ]; then
            CONFIGURED="false"
            MISSING="${MISSING} JIRA_API_TOKEN"
          fi
          if [ -z "${{ secrets.JIRA_BASE_URL }}" ]; then
            CONFIGURED="false"
            MISSING="${MISSING} JIRA_BASE_URL"
          fi

          echo "configured=${CONFIGURED}" >> $GITHUB_OUTPUT

          if [ "$CONFIGURED" = "false" ]; then
            echo "โ๏ธ Jira not configured - missing:${MISSING}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Jira Rollback Issue
        if: steps.check-jira.outputs.configured == 'true'
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT }}
          JIRA_AUTH_TYPE: ${{ secrets.JIRA_AUTH_TYPE }}
        run: |
          # Set auth header based on auth type (api-key for mock Jira, basic for Jira Cloud)
          if [ "$JIRA_AUTH_TYPE" = "api-key" ]; then
            AUTH_HEADER="X-API-Key: ${JIRA_API_TOKEN}"
          else
            AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_EMAIL}:${JIRA_API_TOKEN}" | base64)"
          fi

          # Use configured project or default to TEST
          PROJECT_KEY="${JIRA_PROJECT:-TEST}"

          # Collect rollback details from deploy job outputs
          FAILED_SVC="${{ needs.deploy.outputs.failed_service }}"
          FAIL_REASON="${{ needs.deploy.outputs.failure_reason }}"
          ROLLBACK_STEP="${{ needs.deploy.outputs.rollback_step }}"
          IMAGE_TAG="${{ needs.get-tag.outputs.image_tag }}"

          [ -z "$FAILED_SVC" ] && FAILED_SVC="unknown"
          [ -z "$FAIL_REASON" ] && FAIL_REASON="Canary analysis failed"
          [ -z "$ROLLBACK_STEP" ] && ROLLBACK_STEP="unknown"

          # Build description (API v2 plain text for mock Jira compatibility)
          DESCRIPTION="Canary deployment to QA was automatically rolled back.

          Rollback Details:
          - Failed Service(s): ${FAILED_SVC}
          - Canary Phase: ${ROLLBACK_STEP}
          - Failure Reason: ${FAIL_REASON}

          Deployment Info:
          - Image Tag: ${IMAGE_TAG}
          - Environment: QA (Canary)
          - Triggered by: ${{ github.actor }}
          - Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Application URLs:
          - Vote: https://vote-voting01-qa.agent.opsera.dev
          - Result: https://result-voting01-qa.agent.opsera.dev
          - Argo Rollouts: https://rollouts-voting01-qa.agent.opsera.dev"

          # Create payload (API v2 format)
          PAYLOAD=$(jq -n \
            --arg project "$PROJECT_KEY" \
            --arg summary "[CANARY-ROLLBACK] voting01-qa: ${FAILED_SVC} rolled back at ${ROLLBACK_STEP}" \
            --arg description "$DESCRIPTION" \
            '{
              "fields": {
                "project": {"key": $project},
                "summary": $summary,
                "description": $description,
                "issuetype": {"name": "Bug"},
                "priority": {"name": "High"}
              }
            }')

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/2/issue" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          ISSUE_KEY=$(echo "$BODY" | jq -r '.key // "FAILED"')

          if [ "$ISSUE_KEY" != "FAILED" ] && [ "$ISSUE_KEY" != "null" ] && [ "$HTTP_CODE" = "201" ]; then
            echo "### ๐ Jira Rollback Ticket Created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Issue:** [$ISSUE_KEY](${JIRA_BASE_URL}/browse/${ISSUE_KEY})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Type | Canary Rollback |" >> $GITHUB_STEP_SUMMARY
            echo "| Environment | QA |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed Service | ${FAILED_SVC} |" >> $GITHUB_STEP_SUMMARY
            echo "| Canary Phase | ${ROLLBACK_STEP} |" >> $GITHUB_STEP_SUMMARY
            echo "| Failure Reason | ${FAIL_REASON} |" >> $GITHUB_STEP_SUMMARY
            echo "| Image Tag | ${IMAGE_TAG} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "โ๏ธ Failed to create Jira issue (HTTP $HTTP_CODE)" >> $GITHUB_STEP_SUMMARY
            echo "Response: $BODY" >> $GITHUB_STEP_SUMMARY
          fi
