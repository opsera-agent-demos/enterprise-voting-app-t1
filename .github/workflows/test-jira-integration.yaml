# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TEST JIRA INTEGRATION - Verify Jira API connectivity
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸ§ª Test Jira Integration"

on:
  workflow_dispatch:

jobs:
  test-jira:
    name: "ðŸ“‹ Create Test Jira Ticket"
    runs-on: ubuntu-latest
    steps:
      - name: Verify Jira Configuration
        id: check
        run: |
          echo "### ðŸ§ª Jira Integration Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          CONFIGURED=true
          echo "| Secret | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ secrets.JIRA_API_TOKEN }}" ]; then
            echo "| JIRA_API_TOKEN | âœ… Set |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| JIRA_API_TOKEN | âŒ Missing |" >> $GITHUB_STEP_SUMMARY
            CONFIGURED=false
          fi

          if [ -n "${{ secrets.JIRA_BASE_URL }}" ]; then
            echo "| JIRA_BASE_URL | âœ… Set |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| JIRA_BASE_URL | âŒ Missing |" >> $GITHUB_STEP_SUMMARY
            CONFIGURED=false
          fi

          if [ -n "${{ secrets.JIRA_PROJECT }}" ]; then
            echo "| JIRA_PROJECT | âœ… Set |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| JIRA_PROJECT | âš ï¸ Missing (will default to TEST) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| JIRA_AUTH_TYPE | ${{ secrets.JIRA_AUTH_TYPE || 'basic (default)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "configured=${CONFIGURED}" >> $GITHUB_OUTPUT

          if [ "$CONFIGURED" = "false" ]; then
            echo "âŒ **Jira is not fully configured**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Create Test Ticket
        if: steps.check.outputs.configured == 'true'
        id: create
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT }}
          JIRA_AUTH_TYPE: ${{ secrets.JIRA_AUTH_TYPE }}
        run: |
          # Set auth header
          if [ "$JIRA_AUTH_TYPE" = "api-key" ]; then
            AUTH_HEADER="X-API-Key: ${JIRA_API_TOKEN}"
          else
            AUTH_HEADER="Authorization: Basic $(echo -n "${JIRA_EMAIL}:${JIRA_API_TOKEN}" | base64)"
          fi

          PROJECT_KEY="${JIRA_PROJECT:-TEST}"
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M UTC')

          PAYLOAD=$(jq -n \
            --arg project "$PROJECT_KEY" \
            --arg summary "[TEST] Jira Integration Verification - ${TIMESTAMP}" \
            --arg description "This is a test ticket created by the Opsera AI Agent to verify Jira integration is working correctly.

Created: ${TIMESTAMP}
Repository: ${{ github.repository }}
Triggered by: ${{ github.actor }}
Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

This ticket can be safely closed." \
            '{
              "fields": {
                "project": {"key": $project},
                "summary": $summary,
                "description": $description,
                "issuetype": {"name": "Task"},
                "priority": {"name": "Low"}
              }
            }')

          echo "ðŸ“¤ Creating test ticket in project: ${PROJECT_KEY}"
          echo "ðŸ“¤ Auth type: ${JIRA_AUTH_TYPE:-basic}"
          echo "ðŸ“¤ Base URL: ${JIRA_BASE_URL}"
          echo ""

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "${AUTH_HEADER}" \
            -H "Content-Type: application/json" \
            "${JIRA_BASE_URL}/rest/api/2/issue" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          ISSUE_KEY=$(echo "$BODY" | jq -r '.key // "FAILED"')
          ISSUE_ID=$(echo "$BODY" | jq -r '.id // "FAILED"')

          echo "ðŸ“¥ HTTP Status: ${HTTP_CODE}"
          echo "ðŸ“¥ Response: ${BODY}"

          if [ "$ISSUE_KEY" != "FAILED" ] && [ "$ISSUE_KEY" != "null" ] && [ "$HTTP_CODE" = "201" ]; then
            echo ""
            echo "âœ… SUCCESS! Ticket created: ${ISSUE_KEY}"
            echo ""
            echo "issue_key=${ISSUE_KEY}" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT

            echo "### âœ… Jira Integration Working!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Test Ticket:** [${ISSUE_KEY}](${JIRA_BASE_URL}/browse/${ISSUE_KEY})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Issue Key | \`${ISSUE_KEY}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Issue ID | \`${ISSUE_ID}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Project | \`${PROJECT_KEY}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Type | Task |" >> $GITHUB_STEP_SUMMARY
            echo "| Priority | Low |" >> $GITHUB_STEP_SUMMARY
            echo "| HTTP Status | ${HTTP_CODE} |" >> $GITHUB_STEP_SUMMARY
            echo "| Auth Type | ${JIRA_AUTH_TYPE:-basic} |" >> $GITHUB_STEP_SUMMARY
          else
            echo ""
            echo "âŒ FAILED to create ticket"
            echo "success=false" >> $GITHUB_OUTPUT

            echo "### âŒ Jira Integration Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**HTTP Status:** ${HTTP_CODE}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Response:**" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$BODY" | jq '.' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "$BODY" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Payload Sent:**" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            echo "$PAYLOAD" | jq '.' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
